<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Exam - Academia</title>

<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="../../assets/css/main.css">
<link rel="stylesheet" href="../../assets/css/theme-overrides.css">

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<div id="navbar-container"></div>
<div id="sidebar-container"></div>

<div class="main-content">
<div class="container-fluid">
<div class="d-flex justify-content-between align-items-center mb-4">
<h1>Edit Exam</h1>
<a href="list.html" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back to List</a>
</div>

<div id="loading-container" class="text-center py-5">
<div class="spinner-border text-primary"></div>
</div>

<div id="edit-form-container" style="display:none;">
<div class="card">
<div class="card-body">
<form id="edit-exam-form" novalidate>

<!-- Exam Type -->
<div class="mb-3">
<label class="form-label">Exam Type *</label>
<select id="exam_type" class="form-select" required>
<option value="">Select...</option>
<option value="MIDTERM">Midterm</option>
<option value="FINAL">Final</option>
<option value="QUIZ">Quiz</option>
<option value="PROJECT">Project</option>
</select>
</div>

<div class="row mb-3">
<div class="col-md-4">
<label class="form-label">Exam Date *</label>
<input type="datetime-local" id="exam_date" class="form-control" required>
</div>
<div class="col-md-4">
<label class="form-label">Duration (min) *</label>
<input type="number" id="duration_minutes" class="form-control" min="1" required>
</div>
<div class="col-md-4">
<label class="form-label">Total Marks *</label>
<input type="number" id="total_marks" class="form-control" min="0" step="0.01" required>
</div>
</div>

<div class="mb-3">
<label class="form-label">Room</label>
<select id="room" class="form-select">
<option value="">Select room...</option>
</select>
</div>

<div class="mb-3">
<label class="form-label">Instructions</label>
<textarea id="instructions" class="form-control" rows="4"></textarea>
</div>

<div class="text-end">
<button id="submit-btn" class="btn btn-primary"><i class="bi bi-check-circle"></i> Update Exam</button>
</div>

</form>
</div>
</div>
</div>

</div>
</div>

<div id="toast-container" class="position-fixed top-0 end-0 p-3"></div>

<script src="../../assets/js/config.js"></script>
<script src="../../assets/js/utils.js"></script>
<script src="../../assets/js/auth.js"></script>
<script src="../../assets/js/api.js"></script>

<script>
let examId = null;
let classInstanceId = null; // ✅ store class_instance ID

function unwrapResponse(res) {
    if (res?.status === 'success' && res.data) return res.data;
    if (res?.results || res?.id) return res;
    if (Array.isArray(res)) return { results: res };
    return null;
}

$(document).ready(function () {
    if (!requireRole([CONFIG.ROLES.ADMIN, CONFIG.ROLES.REGISTRAR])) return;

    $('#navbar-container').load('../../components/navbar.html');
    $('#sidebar-container').load('../../components/sidebar.html');

    examId = new URLSearchParams(window.location.search).get('id');
    if (!examId) {
        showToast('Exam ID is required', 'error');
        return;
    }

    loadRooms();
    loadExam();

    $('#edit-exam-form').on('submit', submitForm);
});

function loadRooms(page = 1) {
    RoomAPI.list({ page })
        .then(res => {
            const data = unwrapResponse(res);
            if (!data?.results) return;

            data.results.forEach(room => {
                $('#room').append(
                    `<option value="${room.id}">
                        ${escapeHtml(room.building)} - ${escapeHtml(room.room_number)}
                     </option>`
                );
            });

            if (data.next) loadRooms(page + 1);
        });
}

function loadExam() {
    ExamAPI.get(examId)
        .then(res => {
            const exam = unwrapResponse(res);
            if (!exam?.id) throw res;

            $('#exam_type').val(exam.exam_type || '');
            $('#duration_minutes').val(exam.duration_minutes || '');
            $('#total_marks').val(exam.total_marks || '');
            $('#instructions').val(exam.instructions || '');

            if (exam.exam_date) {
                $('#exam_date').val(new Date(exam.exam_date).toISOString().slice(0,16));
            }

            let roomId = exam.room_info?.id || exam.room?.id || exam.room || '';
            $('#room').val(roomId);

            // ✅ Set the class_instance ID from exam object
            classInstanceId = exam.class_instance?.id || exam.class_instance || null;
            if (!classInstanceId) {
                showToast('Exam missing class instance!', 'error');
            }

            $('#loading-container').hide();
            $('#edit-form-container').show();
        })
        .catch(() => {
            showToast('Failed to load exam', 'error');
        });
}

function submitForm(e) {
    e.preventDefault();

    const btn = $('#submit-btn').prop('disabled', true);
    btn.html('<span class="spinner-border spinner-border-sm"></span> Updating');

    if (!classInstanceId) {
        showToast('Cannot update exam: missing class instance', 'error');
        btn.prop('disabled', false).html('<i class="bi bi-check-circle"></i> Update Exam');
        return;
    }

    const payload = {
        class_instance: classInstanceId, // ✅ REQUIRED
        exam_type: $('#exam_type').val(),
        exam_date: new Date($('#exam_date').val()).toISOString(),
        duration_minutes: +$('#duration_minutes').val(),
        total_marks: +$('#total_marks').val(),
        room: $('#room').val() || null,
        instructions: $('#instructions').val() || null
    };

    ExamAPI.update(examId, payload)
        .then(() => {
            showToast('Exam updated successfully', 'success');
            setTimeout(() => location.href = `view.html?id=${examId}`, 1200);
        })
        .catch(() => showToast('Update failed', 'error'))
        .finally(() => {
            btn.prop('disabled', false);
            btn.html('<i class="bi bi-check-circle"></i> Update Exam');
        });
}
</script>
</body>
